-- This migration drops several dozen DB objecs that are no longer (if ever) used.
-- The content of the migration was created automatically with the newly created DeadTestManual
-- test class in the history module, with some subsequent verification and an override for a
-- live table that was detected as dead.

-- The FOREIGN_KEY_CHECKS settings at the beginning and end of this migration ensure that table
-- drops will succeed even if they are not ordered so as to avoid violating foreign key constraints.

DROP PROCEDURE IF EXISTS _spring_cleaning;

DROP FUNCTION IF EXISTS CHECKAGGR;
DROP FUNCTION IF EXISTS cluster_nm1_factor;
DROP FUNCTION IF EXISTS cluster_nm2_factor;
DROP FUNCTION IF EXISTS date_from_ms;
DROP FUNCTION IF EXISTS datetime_from_ms;
DROP FUNCTION IF EXISTS days_ago;
DROP FUNCTION IF EXISTS days_from_now;
DROP FUNCTION IF EXISTS end_of_day;
DROP FUNCTION IF EXISTS end_of_hour;
DROP FUNCTION IF EXISTS end_of_month;
DROP FUNCTION IF EXISTS end_of_month_ms;
DROP FUNCTION IF EXISTS ftn_pm_count_for_month;
DROP FUNCTION IF EXISTS ftn_vm_count_for_month;
DROP FUNCTION IF EXISTS ms_from_date;
DROP FUNCTION IF EXISTS ms_from_datetime;
DROP FUNCTION IF EXISTS start_of_month_ms;
DROP PROCEDURE IF EXISTS clusterAggPreviousDay;
DROP PROCEDURE IF EXISTS kill_idle_threads;
DROP PROCEDURE IF EXISTS populate_AllClusters_PreviousDayAggStats;
DROP PROCEDURE IF EXISTS purge_expired_latest;
DROP PROCEDURE IF EXISTS supplychain_stats_roll_up;
DROP PROCEDURE IF EXISTS trigger_purge_expired;
DROP VIEW IF EXISTS active_vms;
DROP VIEW IF EXISTS app_daily_ins_vw;
DROP VIEW IF EXISTS app_daily_upd_vw;
DROP VIEW IF EXISTS app_groups;
DROP VIEW IF EXISTS app_hourly_ins_vw;
DROP VIEW IF EXISTS app_hourly_upd_vw;
DROP VIEW IF EXISTS app_monthly_ins_vw;
DROP VIEW IF EXISTS app_monthly_upd_vw;
DROP VIEW IF EXISTS ch_daily_ins_vw;
DROP VIEW IF EXISTS ch_daily_upd_vw;
DROP VIEW IF EXISTS ch_hourly_ins_vw;
DROP VIEW IF EXISTS ch_hourly_upd_vw;
DROP VIEW IF EXISTS ch_monthly_ins_vw;
DROP VIEW IF EXISTS ch_monthly_upd_vw;
DROP VIEW IF EXISTS cluster_members_end_of_month;
DROP VIEW IF EXISTS cluster_members_yesterday;
DROP VIEW IF EXISTS cluster_membership;
DROP VIEW IF EXISTS cluster_membership_helper;
DROP VIEW IF EXISTS cluster_stats_monthly_ins_vw;
DROP VIEW IF EXISTS cluster_stats_monthly_upd_vw;
DROP VIEW IF EXISTS cnt_daily_ins_vw;
DROP VIEW IF EXISTS cnt_daily_upd_vw;
DROP VIEW IF EXISTS cnt_hourly_ins_vw;
DROP VIEW IF EXISTS cnt_hourly_upd_vw;
DROP VIEW IF EXISTS cnt_monthly_ins_vw;
DROP VIEW IF EXISTS cnt_monthly_upd_vw;
DROP VIEW IF EXISTS dpod_daily_ins_vw;
DROP VIEW IF EXISTS dpod_daily_upd_vw;
DROP VIEW IF EXISTS dpod_hourly_ins_vw;
DROP VIEW IF EXISTS dpod_hourly_upd_vw;
DROP VIEW IF EXISTS dpod_monthly_ins_vw;
DROP VIEW IF EXISTS dpod_monthly_upd_vw;
DROP VIEW IF EXISTS ds_capacity_by_day;
DROP VIEW IF EXISTS ds_capacity_by_day_per_ds_group;
DROP VIEW IF EXISTS ds_capacity_by_day_util;
DROP VIEW IF EXISTS ds_capacity_by_hour;
DROP VIEW IF EXISTS ds_daily_ins_vw;
DROP VIEW IF EXISTS ds_daily_upd_vw;
DROP VIEW IF EXISTS ds_group_assns;
DROP VIEW IF EXISTS ds_group_members;
DROP VIEW IF EXISTS ds_group_members_helper;
DROP VIEW IF EXISTS ds_groups;
DROP VIEW IF EXISTS ds_hourly_ins_vw;
DROP VIEW IF EXISTS ds_hourly_upd_vw;
DROP VIEW IF EXISTS ds_instances;
DROP VIEW IF EXISTS ds_monthly_ins_vw;
DROP VIEW IF EXISTS ds_monthly_upd_vw;
DROP VIEW IF EXISTS ds_stats_by_day_per_ds_group;
DROP VIEW IF EXISTS ds_stats_by_day_util;
DROP VIEW IF EXISTS ds_stats_by_hour_per_ds_group;
DROP VIEW IF EXISTS ds_util_info_yesterday;
DROP VIEW IF EXISTS ds_util_stats_yesterday;
DROP VIEW IF EXISTS entity_group_assns;
DROP VIEW IF EXISTS entity_group_members;
DROP VIEW IF EXISTS entity_group_members_helper;
DROP VIEW IF EXISTS entity_groups;
DROP VIEW IF EXISTS iom_daily_ins_vw;
DROP VIEW IF EXISTS iom_daily_upd_vw;
DROP VIEW IF EXISTS iom_hourly_ins_vw;
DROP VIEW IF EXISTS iom_hourly_upd_vw;
DROP VIEW IF EXISTS iom_monthly_ins_vw;
DROP VIEW IF EXISTS iom_monthly_upd_vw;
DROP VIEW IF EXISTS notifications_risk;
DROP VIEW IF EXISTS pm_capacity_by_day;
DROP VIEW IF EXISTS pm_capacity_by_day_per_pm_group;
DROP VIEW IF EXISTS pm_capacity_by_day_util;
DROP VIEW IF EXISTS pm_capacity_by_hour;
DROP VIEW IF EXISTS pm_daily_ins_vw;
DROP VIEW IF EXISTS pm_daily_upd_vw;
DROP VIEW IF EXISTS pm_group_assns;
DROP VIEW IF EXISTS pm_group_members;
DROP VIEW IF EXISTS pm_group_members_helper;
DROP VIEW IF EXISTS pm_groups;
DROP VIEW IF EXISTS pm_hourly_ins_vw;
DROP VIEW IF EXISTS pm_hourly_upd_vw;
DROP VIEW IF EXISTS pm_instances;
DROP VIEW IF EXISTS pm_monthly_ins_vw;
DROP VIEW IF EXISTS pm_monthly_upd_vw;
DROP VIEW IF EXISTS pm_stats_by_day_per_pm_group;
DROP VIEW IF EXISTS pm_stats_by_day_util;
DROP VIEW IF EXISTS pm_stats_by_hour_per_pm_group;
DROP VIEW IF EXISTS pm_stats_by_hour_util;
DROP VIEW IF EXISTS pm_stats_by_month_util;
DROP VIEW IF EXISTS pm_util_info_yesterday;
DROP VIEW IF EXISTS pm_util_stats_yesterday;
DROP VIEW IF EXISTS pm_vm_count_by_day_per_pm_group;
DROP VIEW IF EXISTS sc_daily_ins_vw;
DROP VIEW IF EXISTS sc_daily_upd_vw;
DROP VIEW IF EXISTS sc_hourly_ins_vw;
DROP VIEW IF EXISTS sc_hourly_upd_vw;
DROP VIEW IF EXISTS sc_monthly_ins_vw;
DROP VIEW IF EXISTS sc_monthly_upd_vw;
DROP VIEW IF EXISTS service_daily_ins_vw;
DROP VIEW IF EXISTS service_daily_upd_vw;
DROP VIEW IF EXISTS service_monthly_ins_vw;
DROP VIEW IF EXISTS service_monthly_upd_vw;
DROP VIEW IF EXISTS sw_daily_ins_vw;
DROP VIEW IF EXISTS sw_daily_upd_vw;
DROP VIEW IF EXISTS sw_hourly_ins_vw;
DROP VIEW IF EXISTS sw_hourly_upd_vw;
DROP VIEW IF EXISTS sw_monthly_ins_vw;
DROP VIEW IF EXISTS sw_monthly_upd_vw;
DROP VIEW IF EXISTS user_ds_stats_by_day;
DROP VIEW IF EXISTS user_ds_stats_by_hour;
DROP VIEW IF EXISTS user_pm_stats_by_day;
DROP VIEW IF EXISTS user_pm_stats_by_hour;
DROP VIEW IF EXISTS user_vm_stats_by_day;
DROP VIEW IF EXISTS user_vm_stats_by_day_per_group;
DROP VIEW IF EXISTS user_vm_stats_by_hour;
DROP VIEW IF EXISTS user_vm_stats_by_hour_per_group;
DROP VIEW IF EXISTS vdc_daily_ins_vw;
DROP VIEW IF EXISTS vdc_daily_upd_vw;
DROP VIEW IF EXISTS vdc_hourly_ins_vw;
DROP VIEW IF EXISTS vdc_hourly_upd_vw;
DROP VIEW IF EXISTS vdc_monthly_ins_vw;
DROP VIEW IF EXISTS vdc_monthly_upd_vw;
DROP VIEW IF EXISTS vm_capacity_by_day;
DROP VIEW IF EXISTS vm_capacity_by_day_per_vm_group;
DROP VIEW IF EXISTS vm_capacity_by_day_util;
DROP VIEW IF EXISTS vm_capacity_by_hour;
DROP VIEW IF EXISTS vm_daily_ins_vw;
DROP VIEW IF EXISTS vm_daily_upd_vw;
DROP VIEW IF EXISTS vm_group_assns;
DROP VIEW IF EXISTS vm_group_members;
DROP VIEW IF EXISTS vm_group_members_agg;
DROP VIEW IF EXISTS vm_group_members_helper;
DROP VIEW IF EXISTS vm_groups;
DROP VIEW IF EXISTS vm_hourly_ins_vw;
DROP VIEW IF EXISTS vm_hourly_upd_vw;
DROP VIEW IF EXISTS vm_instances;
DROP VIEW IF EXISTS vm_monthly_ins_vw;
DROP VIEW IF EXISTS vm_monthly_upd_vw;
DROP VIEW IF EXISTS vm_stats_by_day_per_vm_group;
DROP VIEW IF EXISTS vm_stats_by_day_per_vm_group_agg;
DROP VIEW IF EXISTS vm_stats_by_day_util;
DROP VIEW IF EXISTS vm_stats_by_hour_per_vm_group;
DROP VIEW IF EXISTS vm_stats_by_hour_per_vm_group_agg;
DROP VIEW IF EXISTS vm_stats_by_hour_util;
DROP VIEW IF EXISTS vm_stats_by_month_util;
DROP VIEW IF EXISTS vm_storage_used_by_day_per_vm_group;
DROP VIEW IF EXISTS vm_util_info_yesterday;
DROP VIEW IF EXISTS vm_util_stats_yesterday;
DROP VIEW IF EXISTS vpod_daily_ins_vw;
DROP VIEW IF EXISTS vpod_daily_upd_vw;
DROP VIEW IF EXISTS vpod_hourly_ins_vw;
DROP VIEW IF EXISTS vpod_hourly_upd_vw;
DROP VIEW IF EXISTS vpod_monthly_ins_vw;
DROP VIEW IF EXISTS vpod_monthly_upd_vw;


DROP PROCEDURE IF EXISTS _drop_tables;
DELIMITER //
CREATE PROCEDURE _drop_tables()
BEGIN

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      SET FOREIGN_KEY_CHECKS = 1;
      RESIGNAL;
    END;

    SET FOREIGN_KEY_CHECKS = 0;
    DROP TABLE IF EXISTS action_modes;
    DROP TABLE IF EXISTS action_savings_unit;
    DROP TABLE IF EXISTS action_states;
    DROP TABLE IF EXISTS action_types;
    DROP TABLE IF EXISTS actions;
    DROP TABLE IF EXISTS actions_OLD;
    DROP TABLE IF EXISTS actions_stats_by_day;
    DROP TABLE IF EXISTS actions_stats_by_hour;
    DROP TABLE IF EXISTS actions_stats_by_month;
    DROP TABLE IF EXISTS bkgd_version_655;
    DROP TABLE IF EXISTS classifications;
    DROP TABLE IF EXISTS classifications_entities_entities;
    DROP TABLE IF EXISTS cloud_service_categories;
    DROP TABLE IF EXISTS cloud_service_providers;
    DROP TABLE IF EXISTS cloud_services;
    DROP TABLE IF EXISTS cluster_members;
    DROP TABLE IF EXISTS customer_info;
    DROP TABLE IF EXISTS entity_assns;
    DROP TABLE IF EXISTS entity_assns_members_entities;
    DROP TABLE IF EXISTS idle_threads_policy;
    DROP TABLE IF EXISTS instance_type_hourly_by_week;
    DROP TABLE IF EXISTS is_persistence;
    DROP TABLE IF EXISTS mkt_snapshots_unplaced;
    DROP TABLE IF EXISTS mkt_snapshots_users;
    DROP TABLE IF EXISTS on_demand_reports;
    DROP TABLE IF EXISTS report_attrs;
    DROP TABLE IF EXISTS report_subscriptions;
    DROP TABLE IF EXISTS scenarios_changes;
    DROP TABLE IF EXISTS scenarios_changes_projection;
    DROP TABLE IF EXISTS scenarios_changes_targets;
    DROP TABLE IF EXISTS scenarios_projection;
    DROP TABLE IF EXISTS scenarios_scopes;
    DROP TABLE IF EXISTS scenarios_users;
    DROP TABLE IF EXISTS spend_stats_by_day;
    DROP TABLE IF EXISTS spend_stats_by_hour;
    DROP TABLE IF EXISTS spend_stats_by_month;
    DROP TABLE IF EXISTS standard_reports;
    DROP TABLE IF EXISTS stat_property_subtype;
    DROP TABLE IF EXISTS stat_property_type;
    DROP TABLE IF EXISTS subscription_attrs;
    DROP TABLE IF EXISTS supply_chain_stats_by_day;
    DROP TABLE IF EXISTS supply_chain_stats_by_month;
    DROP TABLE IF EXISTS ui_reports;
    DROP TABLE IF EXISTS user_attrs;
    DROP TABLE IF EXISTS user_reports;
    DROP TABLE IF EXISTS user_roles;
    DROP TABLE IF EXISTS users;
    DROP TABLE IF EXISTS vc_licenses;
    DROP TABLE IF EXISTS widget_element_datasets;
    DROP TABLE IF EXISTS widget_element_properties;
    DROP TABLE IF EXISTS widget_elements;
    DROP TABLE IF EXISTS widgets;
    DROP TABLE IF EXISTS widgetsets;
    DROP TABLE IF EXISTS widgetsets_default;
    SET FOREIGN_KEY_CHECKS = 1;
END //
DELIMITER ;

CALL _drop_tables();
DROP PROCEDURE _drop_tables;

