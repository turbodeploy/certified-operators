package com.vmturbo.protoc.pojo.gen;

import java.util.Objects;
import java.util.Optional;

import javax.annotation.Generated;
import javax.annotation.Nonnull;
import javax.lang.model.element.Modifier;

import com.google.protobuf.DescriptorProtos.DescriptorProto;
import com.google.protobuf.DescriptorProtos.FileDescriptorProto;
import com.squareup.javapoet.AnnotationSpec;
import com.squareup.javapoet.JavaFile;
import com.squareup.javapoet.MethodSpec;
import com.squareup.javapoet.TypeSpec;

import com.vmturbo.protoc.plugin.common.generator.AbstractDescriptor;
import com.vmturbo.protoc.plugin.common.generator.FileDescriptorProcessingContext;
import com.vmturbo.protoc.plugin.common.generator.MessageDescriptor;
import com.vmturbo.protoc.plugin.common.generator.Registry;

/**
 * {@link FileDescriptorProcessingContext} for generating pojo's.
 */
public class PojoFileDescriptorProcessingContext extends FileDescriptorProcessingContext {

    @Nonnull final PojoCodeGenerator codeGen;

    /**
     * Create a {@link PojoFileDescriptorProcessingContext}.
     *
     * @param generator The generator.
     * @param registry The registry.
     * @param fileDescriptorProto The proto file descriptor.
     */
    public PojoFileDescriptorProcessingContext(@Nonnull PojoCodeGenerator generator,
                                               @Nonnull Registry registry,
                                               @Nonnull FileDescriptorProto fileDescriptorProto) {
        super(generator, registry, fileDescriptorProto, new PojoTypeNameFormatter());
        this.codeGen = Objects.requireNonNull(generator);
    }

    @Nonnull
    @Override
    protected String generateFileContents() {
        final AnnotationSpec generatedAnnotation = AnnotationSpec.builder(Generated.class)
            .addMember("value", "\"by $L compiler plugin\"", generator.getPluginName())
            .addMember("comments", "\"Source: $L\"", fileDescriptorProto.getName())
            .build();

        final TypeSpec.Builder outerClass = TypeSpec.classBuilder(getOuterClass().getPluginJavaClass())
            .addModifiers(Modifier.PUBLIC)
            .addAnnotation(generatedAnnotation);

        MethodSpec constructor = MethodSpec.constructorBuilder()
            .addModifiers(Modifier.PRIVATE)
            .addJavadoc("Private constructor for outer containing class to prevent construction.")
            .build();
        outerClass.addMethod(constructor);

        for (final DescriptorProto proto : fileDescriptorProto.getMessageTypeList()) {
            final AbstractDescriptor descriptor = registry.getMessageDescriptor(
                typeNameFormatter.formatTypeName(proto.getName()));
            if (descriptor instanceof MessageDescriptor) {
                final MessageDescriptor msgDescriptor = (MessageDescriptor)descriptor;
                final Optional<TypeSpec.Builder> typeForMessage = codeGen.generateTypeForMessage(msgDescriptor);
                typeForMessage.ifPresent(type -> outerClass.addType(type.build()));
            }
        }

        final JavaFile file = JavaFile.builder(getJavaPackage(), outerClass.build())
            .addFileComment("Generated by the $L compiler plugin. DO NOT EDIT!\n"
                + "source: $L", generator.getPluginName(), fileDescriptorProto.getName())
            .build();

        return file.toString();
    }
}
