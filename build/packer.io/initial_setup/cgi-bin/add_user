#!/bin/bash
user=$1
passw=$2

# We already have the admin user.
# As part of setting up an admin user, we delete the neteditor user.
# If we find it already been deleted, abort attempt.
/usr/bin/getent passwd neteditor >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Additional attempt to create an admin user"
    logger "Additional attempt to create an admin user"
    exit 0
fi

# Make password guessing for root even more fun
echo "root:$(dd if=/dev/urandom bs=1 count=32 2>/dev/null | base64 | tr '+' '_' | tr '/' '-' | head -c${1:-32};echo)" | /sbin/chpasswd
passwd -l root

/usr/sbin/useradd -d /home/${user} -g wheel -m -r -s /bin/bash ${user}
if [[ $? != 0 ]]; then
    exit 1
fi

echo "${user}:${passw}" | /usr/sbin/chpasswd
if [[ $? != 0 ]]; then
    exit 1
fi

# Remove the special user.
/sbin/userdel neteditor
rm -rf /home/neteditor
systemctl enable sshd
systemctl daemon-reload
systemctl start sshd
# Remove the netuser login binary and copies of the /etc/sudoers
# which were put into /opt
rm -f /opt/netedit
cp /opt/sudoers.backup /etc/sudoers
rm -f /opt/sudoers
rm -f /opt/sudoers.backup

cat <<EOF >/home/${user}/.bashrc
if [ -f /etc/bashrc ]; then
    . /etc/bashrc
fi

alias l='ls -la'
alias c=clear
alias more=less
alias m=less

LESS="-i -j4 -M -X -J"
export LESS
PAGER=less
export PAGER

PATH="/usr/local/bin:\$PATH"

export PS1="[\w]
=> "
EOF
/usr/bin/chown ${user}:wheel /home/${user}/.bashrc
exit 0

