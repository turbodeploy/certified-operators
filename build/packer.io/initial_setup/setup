#!/bin/sh
chmod +x httpd.py
chmod +x cgi-bin/add_user
chmod +x cgi-bin/init_worker.sh

# This password is used later on to convert keystore from PKCS#12 format to JKS.
KEYPASS="jumpy-crazy-experience"
pushd cgi-bin/cert >/dev/null
rm -f * >/dev/null
mkdir -p /tmp/certs >/dev/null
rm -f /tmp/certs/* >/dev/null
openssl genrsa -out key.pem 2048 &>/dev/null
openssl req -new -sha256 -key key.pem -out csr.csr -subj '/CN=turbonomic' >/dev/null
openssl req -x509 -sha256 -days 3650 -key key.pem -in csr.csr -out certificate.pem >/dev/null
openssl pkcs12 -export -out /tmp/certs/key.pkcs12 -inkey key.pem -in certificate.pem -password pass:${KEYPASS} >/dev/null
popd >/dev/null
python httpd.py 443
