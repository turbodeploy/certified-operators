<html>
<style type="text/css">
    .dialog {
        position: absolute;
        margin: auto;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 500px;
        height: 180px;
        background: #f2f2f2;
        border-radius: 30px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        overflow: auto;
    }

    .h4_std {
        border-radius: 5px;
        background-color: #f2f2f2;
        padding-bottom: 10px;
        color: #434343;
        font-family: "Trebuchet MS", Verdana, Helvetica, Arial, sans-serif;
        font-style: normal;
        font-size: 14px;
        width: 425px;
        margin: 0 auto;
    }

    .h4_msg {
        border-radius: 5px;
        background-color: #f2f2f2;
        padding-bottom: 10px;
        font-family: "Trebuchet MS", Verdana, Helvetica, Arial, sans-serif;
        font-style: normal;
        font-size: 14px;
        width: 425px;
        margin: 0 auto;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dialog_inner {
        position: relative;
        top: 0;
        right: 0;
        bottom: 0;
        left: 30px;
        width: 75%;
        float: left;
    }

    .parent {
        position: relative;
        top: 10px;
        right: 0;
        bottom: 0;
        left: 0;
        width: 83px;
        float: right;
    }

    .circle {
        border-radius: 50%;
        width: 60px;
        height: 60px;
        line-height: 60px;
        border-style: solid;
        border-width: 3px;
        border-color: #2c9431;
        text-align: center;
        font-family: "Trebuchet MS", Verdana, Helvetica, Arial, sans-serif;
        font-style: normal;
        font-weight: 600;
        font-size: 16px;
        animation-name: color;
        animation-duration: 5s;
        animation-iteration-count: infinite;
        animation-timing-function: linear;
    }

    .circle_static {
        border-radius: 50%;
        width: 60px;
        height: 60px;
        line-height: 60px;
        border-style: solid;
        border-width: 3px;
        border-color: #2c9431;
        text-align: center;
        font-family: "Trebuchet MS", Verdana, Helvetica, Arial, sans-serif;
        font-style: normal;
        font-weight: 600;
        font-size: 16px;
    }

    .circle_full {
        border-radius: 50%;
        width: 60px;
        height: 60px;
        line-height: 60px;
        z-index: 100;
        animation: fadein 30s;
    }

    @keyframes fadein {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes color {
        0% {
            border-color: #2C9431;
            left: 0;
            top: 0;
        }
        10% {
            border-color: #309A35;
            left: 0;
            top: 0;
        }
        20% {
            border-color: #34A039;
            left: 0;
            top: 0;
        }
        30% {
            border-color: #38A73D;
            left: 0;
            top: 0;
        }
        40% {
            border-color: #3CAD41;
            left: 0;
            top: 0;
        }
        50% {
            border-color: #40B446;
            left: 0;
            top: 0;
        }
        60% {
            border-color: #3CAD41;
            left: 0;
            top: 0;
        }
        70% {
            border-color: #38A73D;
            left: 0;
            top: 0;
        }
        80% {
            border-color: #34A039;
            left: 0;
            top: 0;
        }
        90% {
            border-color: #309A35;
            left: 0;
            top: 0;
        }
        100% {
            border-color: #2C9431;
            left: 0;
            top: 0;
        }
    }
</style>

<head>
    <title>Monitor setup</title>
    <script type="text/javascript">
        // The following variables will be replaced by the python script.
        var thisHost;
        // The regular variables
        var xmlHttp;
        var loaded = false;
        var startTime;
        var failed = false;

        // Interval for checking that we can reach the API component.
        var apiCheckInterval = null;

        // Interval for getting the status and updating the counter.
        var statusUpdateInterval = null;

        function doCheck() {
            if (loaded) {
                return;
            }

            var httpReq = new XMLHttpRequest();
            httpReq.onreadystatechange = function() {
                // If the request completed, and the status is "success", return.
                // We don't care what the response it - the fact that the call succeeded
                // means we reached the API component and it's up.
                if (httpReq.readyState == 4 && httpReq.status == 200) {
                    success();
                }
            }

            // We need to use some API that does not require authentication.
            // checkInit checks if the administrative user is initialized.
            httpReq.open("GET", "https://" + thisHost + ":443/api/v3/checkInit")
            httpReq.send( null );
        }

        // Begins the process of checking whether the API component is up.
        function startApiCheck() {
            if (apiCheckInterval == null) {
                apiCheckInterval = setInterval(doCheck, 5000);
            }

            if (statusUpdateInterval == null) {
                statusUpdateInterval = setInterval(getStatus, 1000);
            }
        }

        // Called when we get a successful request through to the API component.
        // We can assume it's ready to go, and since the startup scripts starts the API component
        // last, we also assume the entire system is ready to go. This is obviously unstable,
        // but it's a short-term solution while we transition to Kubernetes.
        function success() {
            loaded = true;
            if (statusUpdateInterval !== null) {
               clearInterval(statusUpdateInterval);
            }
            if (apiCheckInterval !== null) {
               clearInterval(apiCheckInterval);
            }
            setTimeout(function () {
                successMsg();
            }, 10000);

            setTimeout(function () {
                window.location.href = "https://" + thisHost;
            }, 60000);
            // We are done
            document.getElementById("circle_div").className = 'circle_static';

            setTimeout(function () {
                startFading();
            }, 1000);
        }

        function successMsg() {
            document.getElementById("message").innerHTML = "Starting up Turbonomic XL...";
            setTimeout(function () {
                successMsg();
            }, 10000);
        }

        function startFading() {
            document.getElementById("circle_div").style.borderColor = '#f2f2f2';
            document.getElementById("circle_div").style.transition = 'border-color 15s linear';
            document.getElementById("time").style.color = '#f2f2f2';
            document.getElementById("time").style.transition = 'color 5s linear';
            setTimeout(function () {
                displayLogo();
            }, 5000);
        }

        function displayLogo() {
            time.style.display = 'none';
            time.style.visibility = 'hidden';
            logo.style.display = 'block';
            logo.style.visibility = 'visible';
        }

        function onLoad() {
            startTime = new Date();
            document.getElementById("time").innerHTML = getTimestamp();
            document.getElementById("message").innerHTML = "Initializing Turbonomic XL...";
            startApiCheck();
        }

        function getStatus() {
            xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = getResponse;
            xmlHttp.open("GET", "https://" + thisHost + ":443/status", true);
            xmlHttp.send(null);
        }

        function normalizeTime(param) {
            if (param < 10) {
                param = "0" + param;
            }
            return param
        }
        function getTimestamp() {
            var x = (new Date() - startTime) / 1000;
            var sec = Math.floor(x % 60);
            x /= 60;
            var min = Math.floor(x % 60);
            var m = normalizeTime(min);
            var s = normalizeTime(sec);
            return m + ":" + s;
        }

        function failSetup() {
            document.getElementById("time").innerHTML = "FAIL";
            document.getElementById("circle_div").style.borderColor = 'red';
        }

        function getResponse() {
            // If we've failed, just return.
            if (failed) {
                return;
            }

            document.getElementById("time").innerHTML = getTimestamp();
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                var status;
                // We have a failure.
                if (xmlHttp.responseText.substring(0, 3) == "!! ") {
                    failed = true;
                    status = xmlHttp.responseText.substring(3);
                    document.getElementById("circle_div").className = 'circle_static';
                    setTimeout(function () {
                        failSetup();
                    }, 10);
                } else {
                    status = xmlHttp.responseText;
                }

                document.getElementById("message").innerHTML = status;
            }
        }

    </script>
</head>
<body onload="onLoad()">
<div class="dialog">
    <h4  class="h4_std" align="center"><img src="vmtLogoGreenNew.png"></h4>
    <div class="dialog_inner">
        <h4 class="h4_std">Please wait for Turbonomic XL to fully initialize</h4>
        <h4 class="h4_std">This should take a few minutes</h4>
        <h4 class="h4_msg" id="message"></h4>
    </div>
    <div class="parent">
        <div id="circle_div" class="circle">
            <span id="time"></span>
            <img id="logo" src="logo.png" class="circle_full"
                 style="visibility: hidden; display: none"/>
        </div>
    </div>
</div>
</body>
</html>
