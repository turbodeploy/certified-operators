version: '2'

# Service definitions for extension in production environments. For details see
# https://docs.docker.com/compose/extends/#extending-services
# See also common-services.yml
services:
  rsyslog-prod:
    extends:
      file: common-services.yml
      service: common-service
    image: turbonomic/syslog
    volumes:
      - syslogdata:/home/vmtsyslog
      - auditlogdata:/var/log/turbonomic
    restart: always

  nginx-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/nginx
    ports:
      - "443:8443"
      - "80:8000"
    environment:
      component_type: nginx
      instance_id: nginx-1
    volumes:
      - /tmp/certs:/etc/nginx/certs
      - /tmp/status:/var/www/status
      - nginx-data:/var/lib/nginx
      - nginx-run:/var/run
    restart: always

  consul-prod:
    extends:
      file: common-services.yml
      service: common-service
    image: turbonomic/com.vmturbo.consul
    command: ["vmt-server", "-client=0.0.0.0"]
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - "constraint:node==/node-4/"
    networks:
      default:
        # choose an address high enough to avoid IPs for other components that docker will assign
        ipv4_address: 10.10.10.128
    volumes:
      - consuldata:/consul/data
    mem_limit: 50M
    restart: always

  db-prod:
    extends:
      file: common-services.yml
      service: common-service
    image: turbonomic/db
    stop_grace_period: '30m'
    volumes:
      - mysqldata:/var/lib/mysql
      - mysql_log:/var/log
      - mysql_var:/var/run
    restart: always
    environment:
        DB_MEM_PCT_FOR_BUFFER_POOL: 80

  zoo1-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/zookeeper
    restart: always
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: zoo1
    volumes:
      - zoo1-data:/var/lib/zoo

  kafka1-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/kafka
    restart: always
    mem_limit: 20000M
    environment:
      BROKER_ID: 1
      KAFKA_INTERNAL_PORT: 9092
      KAFKA_INTERNAL_BROKER_ADDRESS: kafka1
      ZOOKEEPER_HOSTS: "zoo1:2181"
      KAFKA_LOG_RETENTION_HRS: 24
      KAFKA_MAX_MESSAGE_BYTES: 67108864
    volumes:
      - kafka1-log:/home/kafka/data

  auth-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/auth
    environment:
      component_type: auth
      instance_id: auth-1
      kafkaServers: kafka1:9092
      consul_host: consul
      JAVA_OPTS: "-Xmx512M -verbose:gc -XX:+PrintGCDateStamps"
    volumes:
      - auth:/home/turbonomic/data
    mem_limit: 768M
    restart: always

  clustermgr-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.clustermgr
    environment:
      component_type: clustermgr
      instance_id: clustermgr-1
      node_name: default
      consul_host: consul
      kafkaServers: kafka1:9092
      server_port: 8080
      JAVA_OPTS: "-Xmx384M -verbose:gc -XX:+PrintGCDateStamps"
    volumes:
      - clustermgr:/home/turbonomic/data
    mem_limit: 512M
    restart: always

  api-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.api.component
    environment:
      component_type: api
      instance_id: api-1
      consul_host: consul
      realtimeTopologyContextId: 777777
      kafkaServers: kafka1:9092
    volumes:
      - api:/home/turbonomic/data
      - /tmp/certs:/tmp/certs
    restart: always

  market-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/market-component
    environment:
      component_type: market
      instance_id: market-1
      consul_host: consul
      kafkaServers: kafka1:9092
    volumes:
      - market:/home/turbonomic/data
    restart: always

  action-orchestrator-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/action-orchestrator
    environment:
      component_type: action-orchestrator
      instance_id: action-orchestrator-1
      consul_host: consul
      realtimeTopologyContextId: 777777
      kafkaServers: kafka1:9092
    volumes:
      - action-orchestrator:/home/turbonomic/data
    restart: always

  topology-processor-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/topology-processor
    environment:
      component_type: topology-processor
      instance_id: topology-processor-1
      node_name: default
      consul_host: consul
      realtimeTopologyContextId: 777777
      kafkaServers: kafka1:9092
    volumes:
      - topology-processor:/home/turbonomic/data
    restart: always

  arangodb-prod:
    extends:
      file: common-services.yml
      service: common-service
    image: turbonomic/arangodb
    environment:
      ARANGO_ROOT_PASSWORD: "root"
    volumes:
      - arangodb:/var/lib/arangodb3
      - arangodb-apps:/var/lib/arangodb3-apps
      - arangodb-dump:/home/arangodb/arangodb-dump
    stop_grace_period: '30m'
    restart: always

  repository-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.repository-component
    environment:
      component_type: repository
      instance_id: repository-1
      REPOSITORY_ARANGODB_HOST: arangodb
      realtimeTopologyContextId: 777777
      kafkaServers: kafka1:9092
    volumes:
      - repository:/home/turbonomic/data
    restart: always

  group-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.group
    volumes:
      - group:/home/turbonomic/data
    environment:
      consul_host: consul
      component_type: group
      instance_id: group-1
      kafkaServers: kafka1:9092
      realtimeTopologyContextId: 777777
    restart: always

  history-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.history
    volumes:
      - history:/home/turbonomic/data
    environment:
      consul_host: consul
      component_type: history
      instance_id: history-1
      realtimeTopologyContextId: 777777
      logging.level.com.vmturbo.history: info # change to debug to enable more debugging output
      kafkaServers: kafka1:9092
    restart: always

  plan-orchestrator-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.plan.orchestrator
    volumes:
      - plan-orchestrator:/home/turbonomic/data
    environment:
      consul_host: consul
      component_type: plan-orchestrator
      instance_id: plan-orchestrator-1
      realtimeTopologyContextId: 777777
      kafkaServers: kafka1:9092
    restart: always

  reporting-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.reports.component
    volumes:
      - reporting:/home/turbonomic/data
    environment:
      consul_host: consul
      component_type: reporting
      instance_id: reporting-1
      kafkaServers: kafka1:9092
      report.files.output.dir: /home/turbonomic/data
    restart: always

  mediation-vcenter-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.vcenter.component
    environment:
      consul_host: consul
      component_type: mediation-vcenter
      instance_id: mediation-vcenter-1
    volumes:
      - mediation-vcenter:/home/turbonomic/data
    restart: always

  mediation-hyperv-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.hyperv.component
    environment:
      consul_host: consul
      component_type: mediation-hyperv
      instance_id: mediation-hyperv-1
    volumes:
      - mediation-hyperv:/home/turbonomic/data
    restart: always

  mediation-netapp-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.netapp.component
    environment:
      consul_host: consul
      component_type: mediation-netapp
      instance_id: mediation-netapp-1
    volumes:
      - mediation-netapp:/home/turbonomic/data
    restart: always

  mediation-ucs-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.ucs.component
    environment:
      consul_host: consul
      component_type: mediation-ucs
      instance_id: mediation-ucs-1
    volumes:
      - mediation-ucs:/home/turbonomic/data
    restart: always

  mediation-vmax-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.vmax.component
    environment:
      consul_host: consul
      component_type: mediation-vmax
      instance_id: mediation-vmax-1
    volumes:
      - mediation-vmax:/home/turbonomic/data
    restart: always

  mediation-vmm-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.vmm.component
    environment:
      consul_host: consul
      component_type: mediation-vmm
      instance_id: mediation-vmm-1
    volumes:
      - mediation-vmm:/home/turbonomic/data
    restart: always

  mediation-hpe3par-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.hpe3par.component
    environment:
      consul_host: consul
      component_type: mediation-hpe3par
      instance_id: mediation-hpe3par-1
    volumes:
      - mediation-hpe3par:/home/turbonomic/data
    restart: always

  mediation-pure-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.pure.component
    environment:
      consul_host: consul
      component_type: mediation-pure
      instance_id: mediation-pure-1
    volumes:
      - mediation-pure:/home/turbonomic/data
    restart: always

  mediation-scaleio-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.scaleio.component
    environment:
      consul_host: consul
      component_type: mediation-scaleio
      instance_id: mediation-scaleio-1
    volumes:
      - mediation-scaleio:/home/turbonomic/data
    restart: always

  mediation-hds-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.hds.component
    environment:
      consul_host: consul
      component_type: mediation-hds
      instance_id: mediation-hds-1
    volumes:
      - mediation-hds:/home/turbonomic/data
    restart: always

  mediation-compellent-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.compellent.component
    environment:
      consul_host: consul
      component_type: mediation-compellent
      instance_id: mediation-compellent-1
    volumes:
      - mediation-compellent:/home/turbonomic/data
    restart: always

  mediation-xtremio-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.xtremio.component
    environment:
      consul_host: consul
      component_type: mediation-xtremio
      instance_id: mediation-xtremio-1
    volumes:
      - mediation-xtremio:/home/turbonomic/data
    restart: always

  mediation-vplex-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.vplex.component
    environment:
      consul_host: consul
      component_type: mediation-vplex
      instance_id: mediation-vplex-1
    volumes:
      - mediation-vplex:/home/turbonomic/data
    restart: always

  mediation-rhv-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.rhv.component
    environment:
      consul_host: consul
      component_type: mediation-rhv
      instance_id: mediation-rhv-1
    volumes:
      - mediation-rhv:/home/turbonomic/data
    restart: always

  mediation-openstack-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.openstack.component
    environment:
      consul_host: consul
      component_type: mediation-openstack
      instance_id: mediation-openstack-1
    volumes:
      - mediation-openstack:/home/turbonomic/data
    restart: always

  mediation-ucsdirector-prod:
    extends:
      file: common-services.yml
      service: prod-component
    image: turbonomic/com.vmturbo.mediation.ucsdirector.component
    environment:
      consul_host: consul
      component_type: mediation-ucsdirector
      instance_id: mediation-ucsdirector-1
    volumes:
      - mediation-ucsdirector:/home/turbonomic/data
    restart: always
