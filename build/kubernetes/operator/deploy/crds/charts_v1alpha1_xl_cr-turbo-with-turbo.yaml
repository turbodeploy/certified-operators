apiVersion: charts.helm.k8s.io/v1alpha1
kind: Xl
metadata:
  name: xl-release
spec:
  # This configuration file is used as an example on how to enable monitoring Turbonomic with Turbonomic.
  # Default values copied from <project_dir>/helm-charts/xl/values.yaml

  # Default values for xl.
  # This is a YAML-formatted file.
  # Declare variables to be passed into your templates.

  # Any changes run: kubectl apply -f deploy/crds/charts_v1alpha1_xl_cr-turbo-with-turbo.yaml -n turbonomic

  # Global settings
  global:
    repository: turbonomic
    tag: 7.21.200-SNAPSHOT
    externalIP: 10.10.2.15
    externalDbIP: 10.10.2.15

  # Monitoring
  # Enable prometheus mysql exporter
  prometheus-mysql-exporter:
    enabled: true
    # Configure the username and password to login to Turbonomic db
    mysql:
      user: turbodbuser
      pass: turbodbpassword
  # Enable prometheus, and configure a job to scrape metrics from mysql-exporter
  prometheus:
    enabled: true
    extraScrapeConfigs: |
      - job_name: 'xl-mysql'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_label_app
            regex: prometheus-mysql-exporter
            action: keep
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - source_labels:
              - __meta_kubernetes_pod_host_ip
            action: replace
            target_label: host_ip
          - source_labels:
              - __meta_kubernetes_pod_label_app
            regex: prometheus-mysql-exporter
            action: replace
            replacement: "xl"
            target_label: job
          - source_labels:
              - __meta_kubernetes_pod_label_app
            regex: prometheus-mysql-exporter
            action: replace
            replacement: "db"
            target_label: service
