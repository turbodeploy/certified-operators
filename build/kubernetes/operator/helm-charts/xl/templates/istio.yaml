{{- if .Values.global }}
    {{- if .Values.global.istio }}
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
    name: t8c-gateway
spec:
    selector:
        istio: ingressgateway
    servers:
        - hosts:
              - '*'
          port:
              number: 80
              name: http
              protocol: HTTP
          tls:
              httpsRedirect: true
        - hosts:
              - '*'
          port:
              number: 443
              name: https
              protocol: HTTPS
          tls:
              mode: SIMPLE
              serverCertificate: /etc/istio/ingressgateway-certs/tls.crt
              privateKey: /etc/istio/ingressgateway-certs/tls.key
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
    name: ui
spec:
    gateways:
        - t8c-gateway
    hosts:
        - '*'
    http:
        - match:
              - uri:
                    prefix: /apidoc
              - uri:
                    prefix: /swagger
          rewrite:
              uri: /swagger/index.html;
          route:
              - destination:
                    host: api.{{ .Release.Namespace }}.svc.cluster.local
                    port:
                        number: 8080
        - match:
              - uri:
                    exact: /
              - uri:
                    prefix: /api
              - uri:
                    prefix: /app
              - uri:
                    prefix: /assets
              - uri:
                    prefix: /doc
              - uri:
                    exact: /swagger/index.html
              - uri:
                    prefix: /vmturbo/rest
          route:
              - destination:
                    host: api.{{ .Release.Namespace }}.svc.cluster.local
                    port:
                        number: 8080
        - match:
              - uri:
                    prefix: /vmturbo/messages
          route:
              - destination:
                    host: api.{{ .Release.Namespace }}.svc.cluster.local
                    port:
                        number: 8080
          websocketUpgrade: true
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
    name: mediation
spec:
    gateways:
        - t8c-gateway
    hosts:
        - '*'
    http:
        - match:
              - uri:
                    prefix: /vmturbo/remoteMediation
          rewrite:
              uri: /remoteMediation
          route:
              - destination:
                    host: topology-processor.{{ .Release.Namespace }}.svc.cluster.local
                    port:
                        number: 8080
          websocketUpgrade: true
  {{- end -}}
{{- end }}