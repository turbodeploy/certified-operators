#!/bin/bash

# Get value from the  command line
step=${1}
image=${2}
version=${3}

# Functions used throughout the script
usage()
{
	echo
        echo "Useage: `basename $0` ip                     -> show service ip of registry server"
        echo "Useage: `basename $0` tag image version      -> tag image version in the local registry"
        echo "Useage: `basename $0` load image version     -> load local docker image tgz"
        echo "Useage: `basename $0` push image version     -> push tagged version into kube private registry"
        echo "Useage: `basename $0` bulk all version       -> push all tagged version into kube private registry"
        echo "Useage: `basename $0` upgrade image version  -> push all tagged version into kube private registry"
        echo "Useage: `basename $0` upgrade all version    -> push all tagged version into kube private registry"
	echo
        exit -1
}

# Test variables are not empty.
[ -z "${step}" ] && usage

# Check for environment
source /opt/local/etc/turbo.conf
declare -a turboEnv=(${turboEnv})
echo "Running `basename $0` for ${turboEnv} environment"
if [ "${turboEnv}" == "dev" ]
then
	imageBasePath="/opt/xl/kubernetes/images/dev"
else
	imageBasePath="/opt/xl/kubernetes/images/${version}"
fi

# Get registry ip
registryIp=$(kubectl get svc | grep -w registry | awk '{print $3}')

# Show registry local svc ip
if [ "${step}" == "ip" ]
then
  echo "Registry Service ip = ${registryIp}"
fi

# Create a tag to push to the private registry
if [ "${step}" == "tag" ]
then
  [ -z "${image}" ] && usage
  [ -z "${version}" ] && usage
  tagImage=$(sudo /usr/bin/docker images  | grep -w ${image} | grep ${version} | grep registry.turbonomic | awk '{print $3}')
  sudo /usr/bin/docker tag ${tagImage} localhost:5000/turbonomic/${image}:${version}
fi

# Load docker image tgz file
if [ "${step}" == "load" ]
then
  [ -z "${image}" ] && usage
  [ -z "${version}" ] && usage
	tgz=$(ls ${imageBasePath} | grep "${image}")
  sudo /usr/bin/docker load --input ${imageBasePath}/${tgz}
fi

# Push to the private registry
if [ "${step}" == "push" ]
then
  [ -z "${image}" ] && usage
  [ -z "${version}" ] && usage
  sudo /usr/bin/docker push localhost:5000/turbonomic/${image}:${version}
fi

# Push to the private registry
if [ "${step}" == "bulk" ]
then
  [ -z "${image}" ] && usage
  [ -z "${version}" ] && usage
  bulkImages=( $(sudo /usr/bin/docker images | grep localhost | awk '{print $1}' | awk -F/ '{print $3}') )
  for dockerImage in "${bulkImages[@]}"
  do
    sudo /usr/bin/docker push localhost:5000/turbonomic/${dockerImage}:${version}
  done
fi

# Upgrade images in the private registry
if [ "${step}" == "upgrade" ] && [ "${image}" != "all" ]
then
  [ -z "${version}" ] && usage
  tgz=$(ls ${imageBasePath} | grep "${image}")
  sudo /usr/bin/docker load --input ${imageBasePath}/${tgz}
  bulkImages=( $(sudo /usr/bin/docker images | grep localhost | awk '{print $1}' | awk -F/ '{print $3}') )
  tagImage=$(sudo /usr/bin/docker images  | grep -w ${image} | grep ${version} | grep localhost | awk '{print $3}')
  sudo /usr/bin/docker push localhost:5000/turbonomic/${image}:${version}
fi

# Upgrade images in the private registry
if [ "${step}" == "upgrade" ] && [ "${image}" == "all" ]
then
  [ -z "${version}" ] && usage
  for tgz in $(ls ${imageBasePath})
  do
    sudo /usr/bin/docker load --input ${imageBasePath}/${tgz}
  done
  bulkImages=( $(sudo /usr/bin/docker images | grep localhost | awk '{print $1}' | awk -F/ '{print $3}') )
  for dockerImage in "${bulkImages[@]}"
  do
    sudo /usr/bin/docker push localhost:5000/turbonomic/${dockerImage}:${version}
  done
fi
