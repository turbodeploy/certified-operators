#!/usr/bin/env bash


# Command-line utility to interact with voltron. Add
# <xl workspace>/com.vmturbo.voltron/bin/voltron to your PATH, and try it out!
#
# To set up autocomplete, add the following to your .bashrc:
# source <xl workspace>/com.vmturbo.voltron/bin/voltron setup_autocomplete
#
setup_autocomplete() {
   local cur prev

   cur=${COMP_WORDS[COMP_CWORD]}
   prev=${COMP_WORDS[COMP_CWORD-1]}

   case ${COMP_CWORD} in
     1)
       COMPREPLY=($(compgen -W "grpc restore_topology restore_groups restore_cost send_topology set_broadcast_interval get_topology help broadcast" -- ${cur}));;
     2)
       case ${prev} in
            grpc)
                COMPREPLY=($(compgen -W "ls call type parse help" -- ${cur}))
        esac
        ;;
     *)
        COMPREPLY=()
        ;;
    esac
}

print_help() {
   echo "No command specified."
   echo "voltron grpc                   ...    ; Interact with Voltron's gRPC services."
   echo "voltron restore_topology       ...    ; Load topology processor from a ZIP file."
   echo "voltron restore_groups         ...    ; Load groups from a ZIP file."
   echo "voltron restore_cost           ...    ; Load cost diags from a ZIP file."
   echo "voltron restore_action_orchestrator   ; Load action diags from a ZIP file."
   echo "voltron send_topology          ...    ; Broadcast topology."
   echo "voltron broadcast              ...    ; Broadcast topology (alias for send_topology)."
   echo "voltron get_topology           ...    ; Broadcast and return topology. Redirect output to a file to save. Requires grpc_cli."
   echo "voltron set_broadcast_interval ...    ; Set broadcast schedule."
   echo "voltron help                   ...    ; Print this message"
   echo "To set the HTTP port, set the HTTP_PORT environment variable: HTTP_PORT=8081 voltron send_topology"
   echo "To set the gRPC port, set the GRPC_PORT environment variable: GRPC_PORT=9002 voltron grpc ls"
}

set_broadcast_interval() {
  if [ "$#" -lt 1 ]
  then
    echo "voltron set_broadcast_interval <interval in minutes>"
  else
    echo "Setting broadcast interval to $1"
    curl -X POST --header 'Content-Type: application/json;charset=UTF-8' --header 'Accept: application/json' -d "{
      \"intervalMinutes\": $1
    }" http://localhost:${HTTP_PORT}/topology-processor/ScheduleService/setBroadcastSchedule
  fi
}

send_topology() {
  curl -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' http://localhost:${HTTP_PORT}/topology-processor/topology/send
}


restore_diag() {
  if [ "$#" -lt 3 ]
  then
    echo "voltron $1 <path to topology processor ZIP file>"
  else
    pathToFile="$( cd "$( dirname "$3" )" && pwd )"
    fileName=$(basename $3)
    fullPath=${pathToFile}/${fileName}

    echo "Restoring from: ${fullPath}"
    curl --header 'Content-Type: application/zip' --data-binary @${fullPath} http://localhost:${HTTP_PORT}/$2/internal-state
  fi
}

get_topology() {
  command -v grpc_cli >/dev/null 2>&1 || { echo >&2 "Please install grpc_cli \(brew install grpc\)."; exit 1; }

  echo >&2 "Broadcasting and returning topology. To save, redirect output to a file."
  grpc_cli call localhost:${GRPC_PORT} topology.TopologyService.BroadcastAndReturnTopology ''
}


if [ "$#" -lt 1 ]
then
   print_help
fi

HTTP_PORT=${HTTP_PORT:=8080}
GRPC_PORT=${GRPC_PORT:=9001}

case $1 in
grpc)
  command -v grpc_cli >/dev/null 2>&1 || { echo >&2 "Please install grpc_cli \(brew install grpc\)."; exit 1; }
  if [ "$#" -lt 2 ]
  then
     echo "This is an alternative to grpc_cli <cmd> that automatically targets locally running voltron."
     echo "No command specified"
     echo "voltron grpc ls ...         ; List services"
     echo "voltron grpc call ...       ; Call method"
     echo "voltron grpc type ...       ; Print type"
     echo "voltron grpc parse ...      ; Parse message"
     echo "voltron grpc help ...       ; Print this message, or per-command usage"
  else
     case $2 in
     ls)
       grpc_cli ls localhost:${GRPC_PORT} ${@:3};;
     call)
       grpc_cli call localhost:${GRPC_PORT} ${@:3};;
     type)
       grpc_cli type localhost:${GRPC_PORT} ${@:3};;
     parse)
       grpc_cli parse localhost:${GRPC_PORT} ${@:3};;
     help)
       grpc_cli help ${@:3};;
     esac
  fi;;
help)
  print_help;;
restore_topology)
  restore_diag "restore_topology" "topology-processor" ${@:2};;
restore_action_orchestrator)
  restore_diag "restore_action_orchestrator" "action-orchestrator" ${@:2};;
restore_groups)
  restore_diag "restore_groups" "group" ${@:2};;
restore_cost)
  restore_diag "restore_cost" "cost" ${@:2};;
send_topology)
  send_topology;;
broadcast)
  send_topology;;
get_topology)
  get_topology;;
set_broadcast_interval)
  set_broadcast_interval ${@:2};;
setup_autocomplete)
  complete -o bashdefault -o default -F setup_autocomplete voltron;;
esac

