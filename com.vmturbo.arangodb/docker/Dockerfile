FROM registry.access.redhat.com/ubi8
MAINTAINER Billy O'Connell <billy.oconnell@turbonomic.com>

ENV ARANGO_VERSION 3.3.23-1
ENV ARANGO_URL https://download.arangodb.com/arangodb33/CentOS_7/x86_64/arangodb3-${ARANGO_VERSION}.x86_64.rpm
ENV OPENSSL_URL=https://download.fedoraproject.org/pub/fedora/linux/releases/30/Everything/x86_64/os/Packages/c/compat-openssl10-1.0.2o-5.fc30.x86_64.rpm

# The systemd-coredump userid 999 would be the owner of the /var/lib/arangodb3 directory after the ubi8 update
# We should have created arangodb user with an explicit userid instead of it picking 999
RUN userdel systemd-coredump

# Install rsyslog and other packages
RUN dnf install -y https://download.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm && \
    dnf install -y rsyslog procps-ng jemalloc pwgen && \
    dnf clean all && \
    rm -rf /var/cache/dnf

RUN mkdir /docker-entrypoint-initdb.d && \
    dnf install -y ${OPENSSL_URL} && \
    dnf install -y ${ARANGO_URL} && \
    rm -rf /var/lib/arangodb3/* &&\
    sed -ri \
# https://docs.arangodb.com/latest/Manual/Administration/Configuration/Endpoint.html
        -e 's!127\.0\.0\.1!0.0.0.0!g' \
# https://docs.arangodb.com/latest/Manual/Administration/Configuration/Logging.html
        -e 's!^(file\s*=).*!\1 -!' \
# run as arangodb:arangodb
        -e 's!^#\s*uid\s*=.*!uid = arangodb!' \
        -e 's!^#\s*gid\s*=.*!gid = arangodb!' \
        /etc/arangodb3/arangod.conf

# Recreated the delete user now with a different userid, probably 998
RUN useradd -r -d / -g 997 -s /sbin/nologin systemd-coredump

COPY arangod.conf /etc/arangodb3/
RUN chown arangodb:arangodb /etc/arangodb3/arangod.conf

# Initialization
# The presense of /tmp/init_007 indicates the the fact that arangoDB went through the setup,
# but never started yet. Will be removed on first startup.
RUN mkdir -p /var/lib/arangodb3 && mkdir -p /var/lib/arangodb3-apps && mkdir -p /home/arangodb/arangodb-dump && chown -R arangodb /var/lib/arangodb3 && chown -R arangodb /var/lib/arangodb3-apps && \
chown -R arangodb /home/arangodb && ARANGODB_DEFAULT_ROOT_PASSWORD="root" /usr/sbin/arango-init-database && touch /tmp/init_007 && chown arangodb /tmp/init_007

# rsyslog
ADD rsyslog.conf /etc

# retain the database directory, the Foxx Application directory and the arango dump directory
VOLUME ["/var/lib/arangodb3", "/var/lib/arangodb3-apps", "/home/arangodb/arangodb-dump"]

COPY docker-entrypoint.sh /entrypoint.sh
COPY arango_dump_restore.py /

ENTRYPOINT ["/entrypoint.sh"]
RUN chmod 755 /entrypoint.sh && chmod 755 /arango_dump_restore.py
RUN passwd -l root
USER arangodb

# ArangoDB
EXPOSE 8529

# Dump/Restore webservice
EXPOSE 8599
CMD ["arangod"]
