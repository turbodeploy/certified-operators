annotations:
  list:
    - builtIn: 1
      datasource: -- Grafana --
      enable: true
      hide: true
      iconColor: rgba(0, 211, 255, 1)
      name: Annotations & Alerts
      type: dashboard
description: This report shows Virtual Machines that have been dormant for the past
  several days (lack of CPU activity for 72 hours), and the storage used by those
  VMs.
editable: false
gnetId:
graphTooltip: 0
iteration: 1596205010577
links: []
panels:
  - columns: []
    datasource: $DB
    description: Virtual Machines with 0% vCPU utilization for the selected time period
      and the storage used by those VMs.
    fieldConfig:
      defaults:
        custom: {}
      overrides: []
    fontSize: 100%
    gridPos:
      h: 23
      w: 13
      x: 0
      y: 0
    id: 2
    pageSize:
    showHeader: true
    sort:
      col:
      desc: false
    styles:
      - $$hashKey: object:1394
        alias: Time
        align: auto
        dateFormat: YYYY-MM-DD HH:mm:ss
        pattern: Time
        type: date
      - $$hashKey: object:1395
        alias: ''
        align: auto
        colorMode:
        colors:
          - rgba(245, 54, 54, 0.9)
          - rgba(237, 129, 40, 0.89)
          - rgba(50, 172, 45, 0.97)
        dateFormat: YYYY-MM-DD HH:mm:ss
        decimals: 2
        mappingType: 1
        pattern: Storage Used
        thresholds: []
        type: number
        unit: mbytes
      - $$hashKey: object:1396
        alias: ''
        align: ''
        colorMode:
        colors:
          - rgba(245, 54, 54, 0.9)
          - rgba(237, 129, 40, 0.89)
          - rgba(50, 172, 45, 0.97)
        decimals: 2
        pattern: /.*/
        thresholds: []
        type: string
        unit: short
    targets:
      - format: table
        group: []
        metricColumn: none
        rawQuery: true
        rawSql: |+
          WITH dormant_vms AS (
            SELECT
              e.oid as oid
            FROM
              entity e, metric
            WHERE
              e.type = 'VIRTUAL_MACHINE' AND
              ($__timeFrom(),$__timeTo()) OVERLAPS (e.first_seen, e.last_seen) AND
              metric.entity_oid = e.oid AND
              metric.type = 'VCPU'
              and metric.time between $__timeFrom() and $__timeTo()
            GROUP BY
              e.oid
            HAVING
              sum(metric.utilization) = 0 AND min(metric.time) < (timestamptz $__timeFrom() + interval '1
              hour')
          )
          SELECT
              e.name as "VM Name",
              sub.total as "Storage Used"
          FROM
              entity e
          INNER JOIN LATERAL (
              SELECT
                  sum(metric.consumed) total FROM metric
              WHERE
                  metric.entity_oid = e.oid
                  and metric.type = 'STORAGE_AMOUNT'
                  and metric.time > (timestamptz $__timeTo() - interval '1 hour')
                  and metric.time between $__timeFrom() and $__timeTo()
              GROUP BY
                  metric.time
              ORDER BY
                  time DESC LIMIT 1
          ) AS sub ON true
          WHERE
              e.oid in (select oid from dormant_vms)
          ORDER BY
              sub.total DESC
        refId: A
        select:
          - - params:
                - oid
              type: column
        table: entity
        timeColumn: first_seen
        timeColumnType: timestamptz
        where:
          - name: $__timeFilter
            params: []
            type: macro
          - datatype: text
            name: ''
            params:
              - type
              - '='
              - "'VIRTUAL_MACHINE'"
            type: expression
    timeFrom:
    timeShift:
    title: Storage Used by Dormant VMs
    transform: table
    type: table-old
refresh: false
schemaVersion: 25
style: dark
tags: []
templating:
  list:
    - hide: 2
      includeAll: false
      label:
      multi: false
      name: DB
      options: []
      query: postgres
      queryValue: ''
      refresh: 1
      regex: ''
      skipUrlSync: false
      type: datasource
timepicker:
  refresh_intervals:
    - 10s
    - 30s
    - 1m
    - 5m
    - 15m
    - 30m
    - 1h
    - 2h
    - 1d
timezone: ''
title: Storage Used by Dormant VMs
uid: dormant_vms
