annotations:
  list:
  - builtIn: 1
    datasource: -- Grafana --
    enable: true
    hide: true
    iconColor: rgba(0, 211, 255, 1)
    name: Annotations & Alerts
    type: dashboard
editable: false
gnetId:
graphkTooltip: 0
iteration: 1600812107378
links: []
panels:
- datasource: $DB
  description: This panel shows counts for the entire cluster based on the most recent
    date in the time selection
  fieldConfig:
    defaults:
      custom:
        align:
      mappings:
      - from: ''
        id: 0
        text: ''
        to: ''
        type: 1
        value: ''
      thresholds:
        mode: absolute
        steps:
        - color: green
          value:
      unit: none
    overrides: []
  gridPos:
    h: 6
    w: 7
    x: 0
    y: 0
  id: 6
  options:
    showHeader: true
  pluginVersion: 7.0.1
  targets:
  - format: table
    group: []
    metricColumn: none
    rawQuery: true
    rawSql: |-
      WITH pm_data AS (
        SELECT m.entity_oid,
          avg((e.attrs -> 'num_cpus')::int) AS num_cpus,
          avg(m.capacity) AS mem
        FROM metric m,
          scope_to($__timeTo()::timestamptz - INTERVAL '1 hour', $__timeTo(), 'PHYSICAL_MACHINE', ARRAY[${Cluster:raw} + 0]::bigint[], false) s,
          entity e
        WHERE m.entity_oid = s.oid
          AND m.entity_oid = e.oid
          AND m.time BETWEEN s.from_time AND s.to_time
          AND m.time BETWEEN $__timeTo()::timestamptz - INTERVAL '1 hour' AND $__timeTo()
          AND m.type = 'MEM'
        GROUP BY 1
      ),
      pm_counts AS (
        SELECT COUNT(DISTINCT entity_oid) as pm_count,
          SUM(num_cpus) AS cpu_count,
          SUM(mem) AS pm_mem
        FROM pm_data
      ),
      vm_data AS (
        SELECT m.entity_oid,
          avg((e.attrs -> 'num_cpus')::int) as num_vcpus,
          avg(m.capacity) as vmem
        FROM metric m,
          scope_to($__timeTo()::timestamptz - INTERVAL '1 hour', $__timeTo(), 'VIRTUAL_MACHINE', ARRAY[${Cluster:raw} + 0]::bigint[], false) s,
          entity e
        WHERE m.entity_oid = s.oid
          AND m.entity_oid = e.oid
          AND m.time BETWEEN s.from_time AND s.to_time
          AND m.time BETWEEN $__timeTo()::timestamptz - INTERVAL '1 hour' AND $__timeTo()
          AND m.type = 'VMEM'
        GROUP BY 1
      ),
      vm_counts AS (
        SELECT COUNT(DISTINCT entity_oid) AS vm_count,
          SUM(num_vcpus) AS vcpu_count,
          SUM(vmem) AS vm_vmem
        FROM vm_data
      ),
      stg_data AS (
        SELECT m.entity_oid,
          max(current) FILTER (WHERE m.type = 'STORAGE_AMOUNT') AS stg_used,
          max(capacity) FILTER (WHERE m.type = 'STORAGE_AMOUNT') AS stg_cap,
          max(current) FILTER (WHERE m.type = 'STORAGE_PROVISIONED') AS stg_prov
        FROM metric m,
          scope_to($__timeTo()::timestamptz - INTERVAL '1 hour', $__timeTo(), 'STORAGE', ARRAY[${Cluster:raw} + 0]::bigint[], false) s
        WHERE m.entity_oid = s.oid
          AND m.time BETWEEN s.from_time AND s.to_time
          AND m.time BETWEEN $__timeTo()::timestamptz - INTERVAL '1 hour' AND $__timeTo()
          AND m.type IN ('STORAGE_AMOUNT', 'STORAGE_PROVISIONED')
        GROUP BY 1
      ),
      stg_stats AS (
        SELECT sum(stg_used) AS stg_used,
          sum(stg_cap) AS stg_cap,
          sum(stg_prov) AS stg_prov
        FROM stg_data
      )
      SELECT
        pm_count AS "Hosts",
        vm_count AS "VMs",
        pm_mem / 1024 / 1024 AS "Mem Capacity",
        vm_vmem / 1024 / 1024 AS "VMem Provisioned",
        cpu_count AS "Host CPUs",
        vcpu_count AS "VCPUs Provisioned",
        stg_cap / 1024 AS "Total Storage",
        (stg_cap - stg_used)/ 1024 AS "Available Storage",
        stg_prov / 1024 AS "Allocated Storage"
      FROM pm_counts, vm_counts, stg_stats
    refId: A
    select:
    - - params:
        - savings
        type: column
    table: action_spec
    timeColumn: first_seen
    timeColumnType: timestamp
    where:
    - name: $__timeFilter
      params: []
      type: macro
  timeFrom:
  timeShift:
  title: Current Counts
  transformations:
  - id: organize
    options:
      excludeByName:
        Allocated Storage: true
        Available Storage: true
        Hosts: false
        Mem: true
        Mem Capacity: true
        Total Storage: true
        VMem: true
        VMem Provisioned: true
        VMs: false
      indexByName: {}
      renameByName: {}
  - id: reduce
    options: {}
  - id: organize
    options:
      excludeByName: {}
      indexByName: {}
      renameByName:
        Max: Stats
  type: table
- aliasColors: {}
  bars: false
  dashLength: 10
  dashes: false
  datasource: $DB
  decimals: 2
  fieldConfig:
    defaults:
      custom:
        align:
      mappings: []
      thresholds:
        mode: absolute
        steps:
        - color: green
          value:
        - color: red
          value: 80
    overrides: []
  fill: 0
  fillGradient: 0
  gridPos:
    h: 7
    w: 17
    x: 7
    y: 0
  hiddenSeries: false
  id: 4
  legend:
    avg: false
    current: false
    max: false
    min: false
    show: true
    total: false
    values: false
  lines: true
  linewidth: 2
  nullPointMode: 'null'
  options:
    dataLinks: []
  percentage: false
  pluginVersion: 7.1.5
  pointradius: 2
  points: false
  renderer: flot
  seriesOverrides: []
  spaceLength: 10
  stack: false
  steppedLine: false
  targets:
  - format: time_series
    group: []
    metricColumn: none
    rawQuery: true
    rawSql: |-
      WITH pm_counts AS (
        SELECT
          date_trunc('day', m.time) as time,
          count(distinct m.entity_oid) as pm_count
        FROM
            metric m,
            scope_to($__timeFrom(), $__timeTo(), 'PHYSICAL_MACHINE', ARRAY[${Cluster:raw} + 0], false) s
        WHERE m.entity_oid = s.oid
           AND m.time BETWEEN s.from_time AND s.to_time
           AND m.time BETWEEN $__timeFrom() AND $__timeTo()
           AND m.type = 'MEM'
           AND m.time - date_trunc('day', m.time) < interval '10 minutes'
         GROUP BY 1
      ),
      vm_counts as (
        SELECT
          date_trunc('day', m.time) as time,
          count(distinct oid) as vm_count
        FROM
          metric m,
          scope_to($__timeFrom(), $__timeTo(), 'VIRTUAL_MACHINE', ARRAY[${Cluster:raw} + 0], false) s
        WHERE m.entity_oid = s.oid
           AND m.time BETWEEN s.from_time AND s.to_time
           AND m.time BETWEEN $__timeFrom() AND $__timeTo()
           AND m.type = 'VMEM'
           AND m.time - date_trunc('day', m.time) < interval '10 minutes'
          GROUP BY 1
      )
      SELECT
        pm_counts.time as time,
        pm_count as "Hosts",
        vm_count as "VMs"
      FROM
        pm_counts, vm_counts
      WHERE
        pm_counts.time = vm_counts.time
    refId: A
    select:
    - - params:
        - value
        type: column
    timeColumn: time
    where:
    - name: $__timeFilter
      params: []
      type: macro
  thresholds: []
  timeFrom:
  timeRegions: []
  timeShift:
  title: VM and Host Count Over Time
  tooltip:
    shared: true
    sort: 0
    value_type: individual
  transformations:
  - id: calculateField
    options:
      alias: VM / Host Ratio
      binary:
        left: VMs
        operator: /
        reducer: sum
        right: Hosts
      mode: binary
      reduce:
        reducer: sum
  type: graph
  xaxis:
    buckets:
    mode: time
    name:
    show: true
    values: []
  yaxes:
  - format: short
    label:
    logBase: 1
    max:
    min:
    show: true
  - format: short
    label:
    logBase: 1
    max:
    min:
    show: true
  yaxis:
    align: false
    alignLevel:
- datasource: -- Dashboard --
  description: This panel shows current Memory and Storage stats across the cluster,
    based on the most recent date in the time selection.
  fieldConfig:
    defaults:
      custom:
        align:
      mappings: []
      thresholds:
        mode: absolute
        steps:
        - color: green
          value:
        - color: red
          value: 80
      unit: gbytes
    overrides: []
  gridPos:
    h: 7
    w: 7
    x: 0
    y: 6
  id: 14
  options:
    showHeader: true
    sortBy:
    - desc: false
      displayName: Stats
  pluginVersion: 7.0.1
  targets:
  - panelId: 6
    refId: A
  timeFrom:
  timeShift:
  title: Current Stats
  transformations:
  - id: filterFieldsByName
    options:
      include:
        names:
        - Total Storage
        - Available Storage
        - Allocated Storage
        - Mem Capacity
        - VMem Provisioned
  - id: reduce
    options: {}
  - id: organize
    options:
      excludeByName: {}
      indexByName: {}
      renameByName:
        Max: Stats
  type: table
- aliasColors: {}
  bars: false
  dashLength: 10
  dashes: false
  datasource: $DB
  fieldConfig:
    defaults:
      custom: {}
      unit: mbytes
    overrides: []
  fill: 0
  fillGradient: 0
  gridPos:
    h: 7
    w: 17
    x: 7
    y: 7
  hiddenSeries: false
  id: 10
  legend:
    avg: false
    current: false
    max: false
    min: false
    show: true
    total: false
    values: false
  lines: true
  linewidth: 2
  nullPointMode: 'null'
  options:
    dataLinks: []
  percentage: false
  pluginVersion: 7.1.5
  pointradius: 2
  points: false
  renderer: flot
  seriesOverrides:
  - alias: Total Storage
    color: '#37872D'
  - alias: Allocated Storage
    color: '#E0B400'
  - alias: Used Storage
    color: '#8AB8FF'
  spaceLength: 10
  stack: false
  steppedLine: false
  targets:
  - format: time_series
    group: []
    metricColumn: none
    rawQuery: true
    rawSql: |-
      SELECT
         time,
         sum(stor_cap) as "Total Storage",
         sum(stor_used) as "Used Storage",
         sum(stor_prov) as "Allocated Storage"
       FROM
         (SELECT
           date_trunc('day', m.time) as time,
           m.entity_oid,
           MAX(current) FILTER (WHERE m.type = 'STORAGE_AMOUNT') as stor_used,
           MAX(capacity) FILTER (WHERE m.type = 'STORAGE_AMOUNT') as stor_cap,
           MAX(current) FILTER (WHERE m.type = 'STORAGE_PROVISIONED') as stor_prov
         FROM
           metric m,
           scope_to($__timeFrom(), $__timeTo(), 'STORAGE', ARRAY[${Cluster:raw}+0]::bigint[], '${Cluster:raw}' = '0') s
         WHERE
           m.entity_oid = s.oid
           AND m.time BETWEEN s.from_time AND s.to_time
           AND m.type in ('STORAGE_AMOUNT', 'STORAGE_PROVISIONED')
           AND m.time between $__timeFrom() and $__timeTo()
         GROUP BY 1, 2) AS data
       GROUP BY 1
    refId: A
    select:
    - - params:
        - savings
        type: column
    table: action_spec
    timeColumn: first_seen
    timeColumnType: timestamp
    where:
    - name: $__timeFilter
      params: []
      type: macro
  thresholds: []
  timeFrom:
  timeRegions: []
  timeShift:
  title: Storage Over Time
  tooltip:
    shared: true
    sort: 0
    value_type: individual
  transformations: []
  type: graph
  xaxis:
    buckets:
    mode: time
    name:
    show: true
    values: []
  yaxes:
  - format: mbytes
    label:
    logBase: 1
    max:
    min:
    show: true
  - format: short
    label:
    logBase: 1
    max:
    min:
    show: true
  yaxis:
    align: false
    alignLevel:
- datasource: -- Dashboard --
  description: This panel shows current VM ratios across the cluster, based on the
    most recent date in the time selection.
  fieldConfig:
    defaults:
      custom:
        align:
      decimals: 2
      mappings: []
      thresholds:
        mode: absolute
        steps:
        - color: green
          value:
        - color: red
          value: 80
      unit: none
    overrides:
    - matcher:
        id: byName
        options: Field
      properties:
      - id: custom.width
        value: 196
  gridPos:
    h: 9
    w: 7
    x: 0
    y: 13
  id: 8
  options:
    showHeader: true
    sortBy: []
  pluginVersion: 7.0.1
  targets:
  - panelId: 6
    refId: A
  timeFrom:
  timeShift:
  title: Current Ratios
  transformations:
  - id: calculateField
    options:
      binary:
        left: VMs
        operator: /
        reducer: sum
        right: Hosts
      mode: binary
      reduce:
        reducer: sum
      replaceFields: false
  - id: calculateField
    options:
      alias: VMs / Mem (GB)
      binary:
        left: VMs
        operator: /
        reducer: sum
        right: Mem Capacity
      mode: binary
      reduce:
        include: []
        reducer: sum
  - id: calculateField
    options:
      alias: VMs / VCPUs
      binary:
        left: VMs
        operator: /
        reducer: sum
        right: VCPUs Provisioned
      mode: binary
      reduce:
        reducer: sum
  - id: calculateField
    options:
      alias: Mem (GB) / VMs
      binary:
        left: Mem Capacity
        operator: /
        reducer: sum
        right: VMs
      mode: binary
      reduce:
        reducer: sum
  - id: calculateField
    options:
      alias: VCPUs / VMs
      binary:
        left: VCPUs Provisioned
        operator: /
        reducer: sum
        right: VMs
      mode: binary
      reduce:
        reducer: sum
  - id: calculateField
    options:
      alias: Allocated_TB
      binary:
        left: Allocated Storage
        operator: /
        reducer: sum
        right: 1024
      mode: binary
      reduce:
        reducer: sum
  - id: calculateField
    options:
      alias: VMs / Storage Allocated (TB)
      binary:
        left: VMs
        operator: /
        reducer: sum
        right: Allocated_TB
      mode: binary
      reduce:
        reducer: sum
  - id: calculateField
    options:
      alias: VCPUs / CPUs
      binary:
        left: VCPUs Provisioned
        operator: /
        reducer: sum
        right: Host CPUs
      mode: binary
      reduce:
        reducer: sum
  - id: filterFieldsByName
    options:
      include:
        names:
        - time
        - VMs / Hosts
        - VMs / Mem (GB)
        - VMs / VCPUs
        - Mem (GB) / VMs
        - VCPUs / VMs
        - VMs / Storage Allocated (TB)
        - VCPUs / CPUs
  - id: organize
    options:
      excludeByName: {}
      indexByName:
        Mem (GB) / VMs: 6
        VCPUs / CPUs: 2
        VCPUs / VMs: 4
        VMs / Hosts: 1
        VMs / Mem (GB): 5
        VMs / Storage Allocated (TB): 7
        VMs / VCPUs: 3
        time: 0
      renameByName: {}
  - id: reduce
    options: {}
  - id: organize
    options:
      excludeByName: {}
      indexByName: {}
      renameByName:
        Max: Ratios
  type: table
- aliasColors: {}
  bars: false
  dashLength: 10
  dashes: false
  datasource: $DB
  fieldConfig:
    defaults:
      custom: {}
      unit: percent
    overrides: []
  fill: 0
  fillGradient: 0
  gridPos:
    h: 7
    w: 17
    x: 7
    y: 14
  hiddenSeries: false
  id: 12
  legend:
    avg: false
    current: false
    max: false
    min: false
    show: true
    total: false
    values: false
  lines: true
  linewidth: 2
  nullPointMode: 'null'
  options:
    dataLinks: []
  percentage: false
  pluginVersion: 7.1.5
  pointradius: 2
  points: false
  renderer: flot
  seriesOverrides: []
  spaceLength: 10
  stack: false
  steppedLine: false
  targets:
  - format: time_series
    group: []
    metricColumn: none
    rawQuery: true
    rawSql: |-
      SELECT
        date_trunc('day', m.time) AS time,
         sum(m.current) FILTER (WHERE m.type = 'CPU') /
            sum(m.capacity) FILTER (WHERE m.type = 'CPU') * 100 AS "CPU Utilization",
         sum(m.current) FILTER (WHERE m.type = 'MEM') /
            sum(m.capacity) FILTER (WHERE m.type = 'MEM') * 100 AS "Mem Utilization"
      FROM metric m,
        scope_to($__timeFrom(), $__timeTo(), 'PHYSICAL_MACHINE', ARRAY[${Cluster:raw} + 0]::bigint[], false) s
      WHERE
        m.entity_oid = s.oid
        AND m.time BETWEEN s.from_time AND s.to_time
        AND m.type IN ('MEM', 'CPU')
        AND m.time BETWEEN $__timeFrom() AND $__timeTo()
      GROUP BY 1
      ORDER BY 1
    refId: A
    select:
    - - params:
        - value
        type: column
    timeColumn: time
    where:
    - name: $__timeFilter
      params: []
      type: macro
  thresholds: []
  timeFrom:
  timeRegions: []
  timeShift:
  title: CPU and Mem Utilization Over Time
  tooltip:
    shared: true
    sort: 0
    value_type: individual
  type: graph
  xaxis:
    buckets:
    mode: time
    name:
    show: true
    values: []
  yaxes:
  - format: percent
    label:
    logBase: 1
    max:
    min:
    show: true
  - format: short
    label:
    logBase: 1
    max:
    min:
    show: true
  yaxis:
    align: false
    alignLevel:
schemaVersion: 25
style: dark
tags: []
templating:
  list:
  - hide: 2
    includeAll: false
    label:
    multi: false
    name: DB
    options: []
    query: postgres
    refresh: 1
    regex: ''
    skipUrlSync: false
    type: datasource
  - allValue:
    datasource: $DB
    definition: ''
    hide: 0
    includeAll: false
    label:
    multi: false
    name: Cluster
    options: []
    query: |-
      SELECT
        name as __text,
        oid as __value
      FROM
        entity
      WHERE
        entity.type = 'COMPUTE_CLUSTER'
        AND ($__timeFrom(),$__timeTo()) OVERLAPS (first_seen, last_seen)
      ORDER BY 1
    refresh: 2
    regex: ''
    skipUrlSync: false
    sort: 0
    tagValuesQuery: ''
    tags: []
    tagsQuery: ''
    type: query
    useTags: false
time:
  from: now-7d
  to: now
timepicker:
  refresh_intervals:
  - 10s
  - 30s
  - 1m
  - 5m
  - 15m
  - 30m
  - 1h
  - 2h
  - 1d
timezone: ''
title: Individual Host Cluster Summary
uid: individual_cluster_summary
